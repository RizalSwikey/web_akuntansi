{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block title %}Laporan Laba Rugi{% endblock %}

{% block content %}
<div class="flex h-screen">

  {% include 'core/partials/sidebar.html' %}

  <main id="main-content" class="flex-1 p-8 overflow-y-auto">

    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold">Laporan Laba Rugi</h1>

      <div class="relative" id="export-dropdown-container">
        <button id="export-toggle-btn" type="button" class="bg-gray-700 text-white py-2 px-6 rounded-lg font-semibold hover:bg-gray-600 flex items-center">
          Export Laporan
          <svg class="w-4 h-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
          </svg>
        </button>
        
        <div id="export-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-10 hidden border border-slate-200 overflow-hidden">
          <a href="{% url 'core:export_excel' report.id %}" class="block px-4 py-3 text-sm text-slate-700 hover:bg-slate-100 font-medium">
            Excel
          </a>
          <a href="{% url 'core:export_pdf' report.id %}" class="block px-4 py-3 text-sm text-slate-700 hover:bg-slate-100 font-medium">
            PDF
          </a>
        </div>
      </div>
      </div>

    <div class="bg-white rounded-2xl p-10 shadow-lg max-w-4xl mx-auto">
      
      <div class="text-center mb-10">
        <h2 class="text-2xl font-bold">{{ report.company_name | default:'Nama Perusahaan' }}</h2>
        <p class="text-xl font-semibold">LAPORAN HARGA POKOK PRODUKSI</p>
        <p class="text-md text-slate-500">{{ report.month | default:'Bulan' }} {{ report.year | default:'Tahun' }}</p>
      </div>

      <div class="space-y-3 max-w-2xl mx-auto mb-16">
        
        <div class="font-bold text-lg">Bahan Baku</div>
        <div class="pl-6 space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-slate-700">Persediaan bahan baku (awal)</span>
            <span class="font-semibold">Rp {{ total_bb_awal | floatformat:0 | intcomma }}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-slate-700">Pembelian Bahan Baku</span>
            <span class="font-semibold">Rp {{ total_bb_pembelian | floatformat:0 | intcomma }}</span>
          </div>
          <div class="flex justify-between items-center border-t pt-2 mt-2">
            <span class="text-slate-700 font-semibold">Persediaan Bahan Baku yang tersedia diproduksi</span>
            <span class="font-semibold">Rp {{ total_bb_awal | add:total_bb_pembelian | floatformat:0 | intcomma }}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-slate-700">Persediaan Bahan Baku (akhir)</span>
            <span class="font-semibold">(Rp {{ total_bb_akhir | floatformat:0 | intcomma }})</span>
          </div>
          <div class="flex justify-between items-center border-t pt-2 mt-2 font-bold">
            <span class="text-slate-900">Total Biaya Bahan Baku</span>
            <span class="text-slate-900">Rp {{ total_bbb | floatformat:0 | intcomma }}</span>
          </div>
        </div>

        <div class="flex justify-between items-center pt-4">
          <span class="font-bold text-lg">Biaya Tenaga Kerja Langsung</span>
          <span class="font-bold text-lg">Rp {{ total_btkl | floatformat:0 | intcomma }}</span>
        </div>

        <div class="font-bold text-lg pt-4">Biaya Overhead Pabrik</div>
        <div class="pl-6 space-y-3 border-b pb-3">
          {% for item in bop_items %}
          <div class="flex justify-between items-center">
            <span class="text-slate-700">{{ item.nama_biaya }}</span>
            <span class="font-semibold">Rp {{ item.total | floatformat:0 | intcomma }}</span>
          </div>
          {% empty %}
          <div class="flex justify-between items-center">
            <span class="text-slate-400 italic">Tidak ada biaya overhead</span>
            <span class="font-semibold">Rp 0</span>
          </div>
          {% endfor %}
        </div>
        <div class="flex justify-between items-center font-bold pl-6">
            <span class="text-slate-900">Total Biaya Overhead Pabrik</span>
            <span class="text-slate-900">Rp {{ total_bop | floatformat:0 | intcomma }}</span>
        </div>

        <div class="flex justify-between items-center font-bold text-lg pt-4 border-t mt-4">
          <span class="text-slate-900">Total Biaya Produksi Bulan ini</span>
          <span class="text-slate-900">Rp {{ total_biaya_produksi | floatformat:0 | intcomma }}</span>
        </div>

        <div class="flex justify-between items-center pt-4">
          <span class="text-slate-700">Persediaan Barang Dalam Proses (BDP Awal)</span>
          <span class="font-semibold">Rp {{ total_bdp_awal | floatformat:0 | intcomma }}</span>
        </div>
        <div class="flex justify-between items-center border-t pt-2 mt-2">
          <span class="text-slate-700 font-semibold">Total Biaya Barang Dalam Proses</span>
          <span class="font-semibold">Rp {{ total_biaya_produksi | add:total_bdp_awal | floatformat:0 | intcomma }}</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-slate-700">Persediaan Barang Dalam Proses (Akhir)</span>
          <span class="font-semibold">(Rp {{ total_bdp_akhir | floatformat:0 | intcomma }})</span>
        </div>
        
        <div class="flex justify-between items-center bg-slate-100 p-3 rounded-lg mt-4">
          <span class="font-bold text-lg">Cost of Goods Manufactured (COGM)</span>
          <span class="font-bold text-lg">Rp {{ cogm | floatformat:0 | intcomma }}</span>
        </div>

        <div class="flex justify-between items-center pt-4">
          <span class="text-slate-700">Persediaan Barang Jadi (Awal)</span>
          <span class="font-semibold">Rp {{ total_bj_awal | floatformat:0 | intcomma }}</span>
        </div>
        <div class="flex justify-between items-center border-t pt-2 mt-2">
          <span class="text-slate-700 font-semibold">Total Biaya Barang Siap untuk Dijual</span>
          <span class="font-semibold">Rp {{ barang_siap_dijual | floatformat:0 | intcomma }}</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-slate-700">Persediaan Barang Jadi (Akhir)</span>
          <span class="font-semibold">(Rp {{ total_bj_akhir | floatformat:0 | intcomma }})</span>
        </div>

        <div class="flex justify-between items-center bg-slate-100 p-3 rounded-lg mt-4">
          <span class="font-bold text-lg">Harga Pokok Penjualan (HPP)</span>
          <span class="font-bold text-lg">Rp {{ total_hpp | floatformat:0 | intcomma }}</span>
        </div>

        <div class="pt-4">
          <span class="font-semibold text-slate-700">HPP Per Produk</span>
          <div class="space-y-2 ml-5">
            {% for item in hpp_per_product %}
            <div class="flex justify-between border-b py-1 px-2 ">
              <span>HPP Per {{ item.product.name }}</span>
              <span>Rp {{ item.hpp_per_unit | floatformat:0 | intcomma }}</span>
            </div>
            {% empty %}
            <div class="flex justify-between border-b py-1 px-2 ">
              <span class="text-slate-400 italic">Belum ada data HPP per produk</span>
            </div>
            {% endfor %}
          </div>
        </div>

      </div>
      <hr class="my-12 border-slate-300" />

      <div class="text-center mb-10">
        <h2 class="text-2xl font-bold">{{ report.company_name | default:'Nama Perusahaan' }}</h2>
        <p class="text-xl font-semibold">LAPORAN LABA RUGI</p>
        <p class="text-md text-slate-500">{{ report.month | default:'Bulan' }} {{ report.year | default:'Tahun' }}</p>
      </div>

      <div class="space-y-4 max-w-2xl mx-auto">
        <div class="font-bold text-lg">Pendapatan</div>
        <div class="pl-6 border-b pb-2">
          <div class="flex justify-between items-center py-1">
            <span>Pendapatan Usaha</span>
            <span>Rp {{ total_pendapatan_usaha | floatformat:0 | intcomma }}</span>
          </div>
          <div class="flex justify-between items-center py-1">
            <span>Pendapatan Lain - Lain</span>
            <span>Rp {{ total_pendapatan_lain | floatformat:0 | intcomma }}</span>
          </div>
        </div>
        <div class="flex justify-between items-center font-bold py-1 pl-6">
          <span>Jumlah Pendapatan</span>
          <span>Rp {{ jumlah_pendapatan | floatformat:0 | intcomma }}</span>
        </div>

        <div class="font-bold text-lg pt-6">Beban</div>
        <div class="pl-6 border-b pb-2">
          <div class="flex justify-between items-center py-1">
            <span>Beban Usaha - HPP</span>
            <span>Rp {{ hpp_total | floatformat:0 | intcomma }}</span>
          </div>
          
          {% for item in beban_usaha_items %}
          <div class="flex justify-between items-center py-1">
            <span>{{ item.name }}</span>
            <span>Rp {{ item.total | floatformat:0 | intcomma }}</span>
          </div>
          {% endfor %}
           <div class="flex justify-between items-center py-1 font-semibold border-t mt-1 pt-1">
            <span>Total Beban Usaha Lainnya</span>
            <span>Rp {{ total_beban_usaha_lainnya | floatformat:0 | intcomma }}</span>
          </div>
          
          {% for item in beban_lain_items %}
          <div class="flex justify-between items-center py-1 mt-2">
            <span>{{ item.name }}</span>
            <span>Rp {{ item.total | floatformat:0 | intcomma }}</span>
          </div>
          {% endfor %}
          <div class="flex justify-between items-center py-1 font-semibold border-t mt-1 pt-1">
            <span>Total Beban Lain - Lain</span>
            <span>Rp {{ total_beban_lain | floatformat:0 | intcomma }}</span>
          </div>
        </div>
        <div class="flex justify-between items-center font-bold py-1 pl-6">
          <span>Jumlah Beban</span>
          <span>Rp {{ jumlah_beban | floatformat:0 | intcomma }}</span>
        </div>

        <div class="space-y-2 pt-8">
          <div class="flex justify-between items-center font-semibold py-2">
            <span class="text-slate-700">Laba (Rugi) Sebelum Pajak Penghasilan</span>
            <span class="font-bold text-black">Rp {{ laba_sebelum_pajak|floatformat:0|intcomma }}</span>
          </div>
          <div class="flex justify-between items-center font-semibold text-slate-700 py-2">
            <span>Beban Pajak Penghasilan</span>
            <span class="font-bold text-black">Rp {{ pajak_penghasilan | floatformat:0 | intcomma }}</span>
          </div>
          <div class="flex justify-between items-center bg-green-100 p-4 rounded-lg mt-4">
            <span class="font-bold text-lg text-green-700">Laba (Rugi) Setelah Pajak Penghasilan</span>
            <span class="font-bold text-lg text-green-700">Rp {{ laba_setelah_pajak | floatformat:0 | intcomma}}</span>
          </div>
        </div>
      </div>
      </div>
  </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.getElementById("export-toggle-btn");
    const menu = document.getElementById("export-menu");
    const container = document.getElementById("export-dropdown-container");

    if (toggleBtn && menu && container) {
        toggleBtn.addEventListener("click", function () {
            menu.classList.toggle("hidden");
        });
    }

    document.addEventListener("click", function (e) {
        if (container && !container.contains(e.target) && menu) {
            menu.classList.add("hidden");
        }
    });
});
</script>
{% endblock %}